<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Freepik Image Generator Test</title>
    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      button {
        background: #3498db;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
      }
      button:hover {
        background: #2980b9;
      }
      button:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
      }
      .log {
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 5px;
        font-family: monospace;
        font-size: 14px;
        max-height: 400px;
        overflow-y: auto;
      }
      .log-item {
        margin: 5px 0;
        padding: 5px;
        border-left: 3px solid #3498db;
        padding-left: 10px;
      }
      .log-item.success {
        border-color: #27ae60;
        color: #27ae60;
      }
      .log-item.error {
        border-color: #e74c3c;
        color: #e74c3c;
      }
      .log-item.info {
        border-color: #3498db;
        color: #3498db;
      }
      .log-item.warning {
        border-color: #f39c12;
        color: #f39c12;
      }
      .image-result {
        margin-top: 20px;
      }
      .image-result img {
        max-width: 100%;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      }
      input,
      textarea {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
      }
      label {
        font-weight: 600;
        display: block;
        margin-top: 15px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üé® Freepik Image Generator Test</h1>
      <p>Test the Freepik image generation API with automatic polling</p>

      <label for="prompt">Prompt:</label>
      <textarea
        id="prompt"
        rows="3"
        placeholder="Describe the image you want to generate..."
      >
A professional product photography of a modern smartphone on a wooden desk, natural lighting, minimal background, high resolution, commercial style</textarea
      >

      <label for="resolution">Resolution:</label>
      <select id="resolution">
        <option value="1k">1K (Faster)</option>
        <option value="2k" selected>2K (Recommended)</option>
        <option value="4k">4K (Slower, Higher Quality)</option>
      </select>

      <label for="model">Model:</label>
      <select id="model">
        <option value="realism" selected>Realism</option>
        <option value="zen">Zen</option>
        <option value="flexible">Flexible</option>
        <option value="fluid">Fluid</option>
        <option value="super_real">Super Real</option>
      </select>

      <br /><br />
      <button onclick="generateImage()" id="generateBtn">
        üöÄ Generate Image
      </button>

      <div class="log" id="log"></div>
      <div class="image-result" id="imageResult"></div>
    </div>

    <script>
      let logContainer = document.getElementById('log');
      let imageContainer = document.getElementById('imageResult');
      let generateBtn = document.getElementById('generateBtn');

      function addLog(message, type = 'info') {
        const logItem = document.createElement('div');
        logItem.className = `log-item ${type}`;
        logItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logContainer.appendChild(logItem);
        logContainer.scrollTop = logContainer.scrollHeight;
      }

      async function generateImage() {
        const prompt = document.getElementById('prompt').value;
        const resolution = document.getElementById('resolution').value;
        const model = document.getElementById('model').value;

        if (!prompt.trim()) {
          addLog('‚ùå Please enter a prompt', 'error');
          return;
        }

        generateBtn.disabled = true;
        logContainer.innerHTML = '';
        imageContainer.innerHTML = '';

        try {
          addLog('üé® Starting image generation...', 'info');
          addLog(`üìù Prompt: ${prompt.substring(0, 50)}...`, 'info');

          // Step 1: Create generation task
          const response = await fetch('/api/freepik-image-gen', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              prompt: prompt,
              resolution: resolution,
              aspect_ratio: 'square_1_1',
              model: model,
            }),
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || 'Failed to start generation');
          }

          const taskId = data.data.task_id;
          addLog(`‚úÖ Task created: ${taskId}`, 'success');
          addLog(`üìä Status: ${data.data.status}`, 'info');

          // Step 2: Poll for completion
          addLog(
            '‚è≥ Waiting for image generation (this may take 10-30 seconds)...',
            'warning'
          );

          const finalImages = await pollForCompletion(taskId);

          addLog(
            `‚úÖ Generation complete! ${finalImages.length} image(s) generated`,
            'success'
          );

          // Display images
          finalImages.forEach((imageUrl, index) => {
            addLog(`üñºÔ∏è Image ${index + 1}: ${imageUrl}`, 'success');
            const img = document.createElement('img');
            img.src = imageUrl;
            img.alt = `Generated image ${index + 1}`;
            imageContainer.appendChild(img);
          });
        } catch (error) {
          addLog(`‚ùå Error: ${error.message}`, 'error');
        } finally {
          generateBtn.disabled = false;
        }
      }

      async function pollForCompletion(taskId) {
        let attempts = 0;
        const maxAttempts = 60; // 3 minutes max

        while (attempts < maxAttempts) {
          // Wait 3 seconds before each check
          await new Promise(resolve => setTimeout(resolve, 3000));
          attempts++;

          try {
            const statusResponse = await fetch(
              `/api/freepik-image-gen?task_id=${taskId}`
            );
            const statusData = await statusResponse.json();

            addLog(
              `üîç Poll attempt ${attempts}: Status = ${statusData.data.status}`,
              'info'
            );

            if (statusData.data.status === 'COMPLETED') {
              return statusData.data.generated;
            }

            if (statusData.data.status === 'FAILED') {
              throw new Error('Image generation failed');
            }
          } catch (error) {
            addLog(`‚ö†Ô∏è Poll error: ${error.message}`, 'warning');
            if (attempts >= maxAttempts) {
              throw error;
            }
          }
        }

        throw new Error('Timeout: Image generation took too long');
      }
    </script>
  </body>
</html>
